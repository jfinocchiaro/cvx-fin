\documentclass{article}
\usepackage[T1]{fontenc}
\usepackage{lmodern}

\PassOptionsToPackage{numbers, compress, sort}{natbib}

\usepackage{float}
\usepackage[utf8]{inputenc} % allow utf-8 input
\usepackage{hyperref}       % hyperlinks  %[implicit=false, bookmarks=false]
\usepackage{url}            % simple URL typesetting
\usepackage{booktabs}       % professional-quality tables
\usepackage{amsfonts}       % blackboard math symbols
\usepackage{nicefrac}       % compact symbols for 1/2, etc.
\usepackage{microtype}      % microtypography

\usepackage{mathtools, amsmath, amssymb, amsthm, graphicx, verbatim}
%\usepackage[thmmarks, thref, amsthm]{ntheorem}
\usepackage{color}
\definecolor{darkblue}{rgb}{0.0,0.0,0.2}
\hypersetup{colorlinks,breaklinks,
	linkcolor=darkblue,urlcolor=darkblue,
	anchorcolor=darkblue,citecolor=darkblue}
\usepackage{wrapfig}
\usepackage[font=small]{caption}
\usepackage{subcaption}
\usepackage[colorinlistoftodos,textsize=tiny]{todonotes} % need xargs for below
%\usepackage{accents}
\usepackage{bbm}
\usepackage{xspace}

\usetikzlibrary{calc}
\newcommand{\Comments}{1}
\newcommand{\mynote}[2]{\ifnum\Comments=1\textcolor{#1}{#2}\fi}
\newcommand{\mytodo}[2]{\ifnum\Comments=1%
	\todo[linecolor=#1!80!black,backgroundcolor=#1,bordercolor=#1!80!black]{#2}\fi}
\newcommand{\raf}[1]{\mynote{green}{[RF: #1]}}
\newcommand{\raft}[1]{\mytodo{green!20!white}{RF: #1}}
\newcommand{\jessie}[1]{\mynote{purple}{[JF: #1]}}
\newcommand{\jessiet}[1]{\mytodo{purple!20!white}{JF: #1}}
\newcommand{\proposedadd}[1]{\mynote{orange}{#1}}
\newcommand{\bo}[1]{\mynote{blue}{[Bo: #1]}}
\newcommand{\botodo}[1]{\mytodo{blue!20!white}{[Bo: #1]}}
\newcommand{\btw}[1]{\mytodo{gray!20!white}{BTW: #1}}%TURN OFF FOR NOW \mytodo{gray}{#1}}
\ifnum\Comments=1               % fix margins for todonotes
\setlength{\marginparwidth}{1in}
\fi


\newcommand{\reals}{\mathbb{R}}
\newcommand{\posreals}{\reals_{>0}}%{\reals_{++}}
\newcommand{\dom}{\mathrm{dom}}
\newcommand{\effdom}{\mathrm{effdom}}

\newcommand{\prop}[1]{\mathrm{prop}[#1]}
\newcommand{\eliccts}{\mathrm{elic}_\mathrm{cts}}
\newcommand{\eliccvx}{\mathrm{elic}_\mathrm{cvx}}
\newcommand{\elicpoly}{\mathrm{elic}_\mathrm{pcvx}}
\newcommand{\elicembed}{\mathrm{elic}_\mathrm{embed}}

\newcommand{\cell}{\mathrm{cell}}

\newcommand{\abstain}[1]{\mathrm{abstain}_{#1}}
\newcommand{\mode}{\mathrm{mode}}

\newcommand{\simplex}{\Delta_\Y}

% alphabetical order, by convention
\newcommand{\B}{\mathcal{B}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\I}{\mathcal{I}}
\newcommand{\N}{\mathcal{N}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\R}{\mathcal{R}}
\newcommand{\Sc}{\mathcal{S}}
\newcommand{\U}{\mathcal{U}}
\newcommand{\V}{\mathcal{V}}
\newcommand{\X}{\mathcal{X}}
\newcommand{\Y}{\mathcal{Y}}
\newcommand{\Z}{\mathcal{Z}}

\newcommand{\risk}[1]{\underline{#1}}
\newcommand{\inprod}[2]{\langle #1, #2 \rangle}%\mathrm{int}(#1)}
\newcommand{\inter}[1]{\mathring{#1}}%\mathrm{int}(#1)}
%\newcommand{\expectedv}[3]{\overline{#1}(#2,#3)}
\newcommand{\expectedv}[3]{\E_{Y\sim{#3}} {#1}(#2,Y)}
\newcommand{\toto}{\rightrightarrows}
\newcommand{\strip}{\mathrm{strip}}
\newcommand{\trim}{\mathrm{trim}}
\newcommand{\fplc}{finite-piecewise-linear and convex\xspace} %xspace for use in text
\newcommand{\conv}{\mathrm{conv}}
\newcommand{\indopp}{\bar{\mathbbm{1}}}
\newcommand{\ones}{\mathbbm{1}}
\DeclarePairedDelimiter\ceil{\lceil}{\rceil}

\newcommand{\Ind}[1]{\ones\{#1\}}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\arginf}{arg\,inf}
\DeclareMathOperator*{\sgn}{sgn}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{corollary}{Corollary}
\newtheorem{conjecture}{Conjecture}

\newtheorem{definition}{Definition}
\newtheorem{assumption}{Assumption}

\title{Lemma 1}
\author{Jessie}

\begin{document}
\maketitle
\paragraph{Setting} 
$\effdom(L) = \reals^d$, and $\E_p L(u,Y) < \infty$ for all $u \in \reals^d$ and $p \in \P$ \jessie{$y \in \Y$?}

$\effdom(L) = \reals^d$ and $L$ convex means that $\partial \E_q L(u,Y) \neq \emptyset$ for all $q \in \P$.

We define $\E_p \partial L(u,Y) = \{\E_p V: V(y) \in \partial L(u,y) p\text{-almost surely}, V \text{ measurable}\}$.
Moreover, let $\V_{u} = \{V : \Y \to \reals^d : V \text{ measurable}, V(\omega) \in \partial L(u,\omega) \forall \omega \in \Omega\}$.
Observe the set $\Z_u(p) := \{\E_p V(Y): V \in \V_u\} \subseteq \E_p \partial L(u,Y)$.
Consider the measurable space $(\Omega, B)$, and assume $B$ is a complete $\sigma$-algebra with respect to $p$. \jessiet{So we get equivalence of measurability of the function and the graph} 

\begin{definition}[Measurable (multifunction)]
	%Let $\B(\reals^d)$ be the Borel $\sigma$-algebra of $\reals^d$.
	Suppose $(\Omega, B)$ is a measurable space and $f:\Omega \toto \reals^d$ a multifunction taking values in the set of nonempty closed subsets of $\reals^d$.
	We say $f$ is weakly measurable if, for every open $U \subseteq \reals^d$, we have
	\begin{equation*}
	\{\omega : f(\omega) \cap U \neq \emptyset\} \in B~.~
	\end{equation*}
\end{definition}

\begin{lemma}
	For any $z \in \reals^d$, there exists a $v \in \E_p \partial L(u,Y)$ such that $\inprod{z}{v} = \E_p L'(u,Y;z)$.
\end{lemma}
\begin{proof}

Fix $z$.
Consider the set-valued function $Q_z : \Omega \to 2^{\reals^d}$ defined by $Q_z(\omega) := \{x \in \partial L(u,\omega) : \inprod{z}{x} = L'(u,\omega;z)\}$.
Now, we want to take a measurable selection $V$ of $Q_z$ satisfying the following conditions:
\begin{enumerate}
	\item $V \in \V_u$.
	\item $\E_p V \in \E_p \partial L(u,Y)$.
	\item $\inprod{z}{\E_p V} = \E_p L'(u,Y,z)$
\end{enumerate} 
If these are true, then we can take $v := \E_p V$ and observe the result.

\bigskip

	
1.  
If $Q_z$ is measurable and closed-valued, then by~\cite[Theorem III.6]{castaing2006convex} \jessiet{Also Rockafellar VA 14.6}, we have a measurable selection $V \in \V_u$ such that $\inprod{z}{V(\omega)} = L'(u,\omega; z)$ for all $\omega \in \Omega$.

Thus, we show $Q_z$ is measurable and closed-valued.
We first have $Q_z$ is closed-valued since the directional derivative is the argmax of a linear function over a compact set, which is also closed.

In order to show that $Q_z$ is $B$-measurable, it is equivalent to show $gr(Q_z)$ is $B \otimes \B(\reals^d)$-measurable since $B$ is a complete $\sigma$-algebra with respect to $p$~\cite[Chapter III]{castaing2006convex}. 
Now, consider $gr(Q_z) = gr(Q) \cap gr(R)$, where $Q: \omega \mapsto \partial L(u,\omega)$ and $R : \omega \mapsto \{x \mid \inprod{z}{x} = L'(u,\omega;z)\}$.
As $Q$ is $B$-measurable~\cite[Corollary 4.6]{ROCKAFELLAR1969measurable}, we have $gr(Q)$ is $B \otimes \B(\reals^d)$-measurable by~\cite[Chapter III]{castaing2006convex}.
Moreover, $gr(R)$ is measurable as it is the graph of a linear multifunction, hence measurable.
Now we can take $gr(Q_z) = gr(Q) \cap gr(R)$, which is measurable by closure under intersections, so $gr(Q_z)$ is $B \otimes \B(\reals^d)$-measurable, and hence $Q_z$ is $B$-measurable~\cite[Chapter III]{castaing2006convex}.

\iffalse
\jessiet{If $R$ was compact}
As measurable functions are closed under (countable) intersections, we can simply show $Q_z$ intersection of measurable functions; namely, since we have $Q_z(\omega) = Q: \omega \mapsto \partial L(u,\omega) \cap R : \omega \mapsto \{x \in \reals^d : \inprod{z}{x} = L'(u,\omega;z)\}$.
\jessiet{Look at strong measurability or see if there's a result of closure under intersections}
\jessie{If $R$ is compact, then we are done by Castaing Valadier Prop iii.4}

Moreover, the function $Q$ is measurable by~\cite[Corollary 4.6]{ROCKAFELLAR1969measurable}.
Moreover, $R$ is measurable as $L'$ is measurable and $\inprod{z}{\cdot}$ is continuous in its second argument, hence Borel.

As $Q_z$ is the intersection of these two functions, we conclude $Q_z$ is measurable by~\cite[Prop iii.4]{castaing2006convex} and closed-valued, and therefore has a measurable selection $V \in \V_u$ such that $\inprod{z}{V(\omega)} = L'(u,\omega;z)$ for all $\omega \in \Omega$.
\fi


%\jessie{Notes to self; ignore}
%$g(\omega) = \{c \in \reals^d : \inprod{z}{c} = L'(u,\omega;z)\}$.
%For all closed $U \in \reals^d$, have $\{\omega : \{c: \inprod{z}{c} = L'(u,\omega;z)\} \cap U \neq \emptyset\} \in \B(\Omega)$

\bigskip 

2.  
This statement follows trivially as $\E_p V \in \Z_p(u) \subseteq \E_p \partial L(u,Y)$. 

\bigskip

3.
We want to show $\inprod{z}{v} = \E_p L'(u,Y,z)$.
This follows from linearity of expectation and construction of $V$; to see this, consider
\begin{align*}
\inprod{z}{v} &= \inprod{z}{\E_p V} \\
 &= \E_p \inprod{z}{V}
 \end{align*}
 The expectation can be pulled out of the inner product because $V$ is finite for all $\omega \in \Omega$ as it is contained in $\partial L(u,\omega)$, which is compact as $L$ is finite and convex for all $u \in \reals^d$.
 \begin{align*}
 \E_p \inprod{z}{V} &= \int \inprod{z}{V(\omega)} dp\omega \\
 &= \int L'(u,\omega; z) dp\omega \\
 &= \E_p L'(u,Y;z)
\end{align*}



\iffalse
	Suppose we are given $z\in \reals^d$.
	We have $\E_p \partial L(u,Y)$ compact (by convexity of $L$).
	Additionally, we know for all $\omega \in \Omega$, $\sup_{x \in \partial L'(u,\omega,z)} \inprod{x}{z} := \delta_{\partial L(u,\omega)}(z)$ is attained, and for any $v \in \delta_{\partial L(u,\omega)}(z)$, we particularly have $v \in \partial L'(u,\omega, z)$.
	
	
	
	\begin{itemize}
		\item $v \in \E_p \partial L(u,Y)$
		\item $\inprod{z}{v'} = \E_p L'(u,Y,z)$.
	\end{itemize}
\fi	
	 
\end{proof}

\bibliographystyle{ieeetr}
\bibliography{refs-selection}

\end{document}